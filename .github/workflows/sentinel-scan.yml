name: "ğŸ“¡ Stock Sentinel Scan"

on:
  schedule:
    # ì¥ì¤‘ (ET 09:00-16:00 = UTC 14:00-21:00): 15ë¶„ ê°„ê²©, í‰ì¼
    - cron: '*/15 14-20 * * 1-5'
    # ì¥í›„ (ET 16:00-18:00 = UTC 21:00-23:00): 30ë¶„ ê°„ê²©
    - cron: '0,30 21-22 * * 1-5'
    # ì¥ì™¸ ì•¼ê°„ (UTC 23, 0~13): 1ì‹œê°„ ê°„ê²©
    - cron: '0 23 * * 1-5'
    - cron: '0 0-13 * * 1-5'
    # ì£¼ë§: 4ì‹œê°„
    - cron: '0 */4 * * 0,6'

  workflow_dispatch:
    inputs:
      ticker:
        description: 'ìŠ¤ìº”í•  ì¢…ëª© (ë¹„ìš°ë©´ ì „ì²´)'
        required: false
        default: ''
      force_alert:
        description: 'ê°•ì œ ì•Œë¦¼ (í…ŒìŠ¤íŠ¸ìš©)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ Install
        run: pip install -r requirements.txt

      - name: ğŸ“¡ Scan
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SCAN_MODE: market_open
          SCAN_TICKER: ${{ github.event.inputs.ticker || '' }}
          FORCE_ALERT: ${{ github.event.inputs.force_alert || 'false' }}
        run: cd sentinel && python run_scan.py

      - name: ğŸ’¾ Save DB
        run: |
          git config user.name "Sentinel Bot"
          git config user.email "sentinel@bot"
          git add -f sentinel/storage/sentinel.db || true
          git diff --cached --quiet || git commit -m "ğŸ“¡ scan $(date -u +%H:%M)" && git push || true
