<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì° Sentinel ‚Äî Watchlist</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap');

:root {
  --bg: #0c0f16;
  --surface: #141821;
  --surface2: #1a1f2e;
  --surface3: #222838;
  --border: #2a3144;
  --border-active: #3b82f6;
  --text: #e8ecf4;
  --text2: #8b95a8;
  --text3: #5c6478;
  --blue: #3b82f6;
  --green: #22c55e;
  --green-dim: rgba(34,197,94,0.12);
  --red: #ef4444;
  --red-dim: rgba(239,68,68,0.1);
  --amber: #f59e0b;
  --purple: #8b5cf6;
  --cyan: #06b6d4;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
}

/* Header */
.header {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  max-width: 800px;
  margin: 0 auto;
}

.header-left { display: flex; align-items: center; gap: 12px; }
.header-left h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
.header-left .dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 8px rgba(34,197,94,0.5);
  animation: pulse 2s ease infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.header-right { display: flex; gap: 8px; }

.badge {
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  font-family: 'DM Mono';
}

.badge-active { background: var(--green-dim); color: var(--green); }
.badge-total { background: var(--surface2); color: var(--text2); }

/* Toolbar */
.toolbar {
  max-width: 800px;
  margin: 16px auto;
  padding: 0 24px;
  display: flex;
  gap: 8px;
  align-items: center;
}

.search-box {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 14px;
  color: var(--text);
  font-size: 14px;
  font-family: 'DM Sans';
  outline: none;
  transition: border-color 0.2s;
}

.search-box:focus { border-color: var(--blue); }
.search-box::placeholder { color: var(--text3); }

.btn {
  padding: 10px 16px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-size: 13px;
  font-weight: 600;
  font-family: 'DM Sans';
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.btn:hover { background: var(--surface2); border-color: var(--text3); }
.btn-primary { background: var(--blue); border-color: var(--blue); color: #fff; }
.btn-primary:hover { background: #2563eb; }
.btn-save { background: var(--green); border-color: var(--green); color: #fff; }
.btn-save:hover { background: #16a34a; }
.btn-save:disabled { opacity: 0.4; cursor: not-allowed; }

/* Card List */
.list {
  max-width: 800px;
  margin: 0 auto;
  padding: 8px 24px 100px;
}

.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  margin-bottom: 8px;
  overflow: hidden;
  transition: all 0.2s;
}

.card:hover { border-color: var(--text3); }
.card.inactive { opacity: 0.45; }
.card.inactive:hover { opacity: 0.65; }

.card-main {
  display: flex;
  align-items: center;
  padding: 16px 18px;
  gap: 14px;
  cursor: pointer;
  user-select: none;
}

/* Toggle Switch */
.toggle {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.toggle input { display: none; }

.toggle-track {
  position: absolute;
  inset: 0;
  background: var(--surface3);
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.25s;
}

.toggle input:checked + .toggle-track { background: var(--green); }

.toggle-thumb {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 18px;
  height: 18px;
  background: #fff;
  border-radius: 50%;
  transition: transform 0.25s;
  pointer-events: none;
}

.toggle input:checked ~ .toggle-thumb { transform: translateX(20px); }

/* Card Content */
.card-info { flex: 1; min-width: 0; }

.card-top {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 3px;
}

.ticker {
  font-family: 'DM Mono';
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.name { font-size: 13px; color: var(--text2); }

.card-bottom {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

.tag {
  padding: 2px 7px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  background: var(--surface3);
  color: var(--text3);
}

.tag-sector { background: rgba(59,130,246,0.1); color: var(--blue); }
.tag-china-high { background: var(--red-dim); color: var(--red); }
.tag-china-medium { background: rgba(245,158,11,0.1); color: var(--amber); }

.expand-btn {
  background: none;
  border: none;
  color: var(--text3);
  font-size: 18px;
  cursor: pointer;
  padding: 4px;
  transition: all 0.2s;
  flex-shrink: 0;
}

.expand-btn:hover { color: var(--text2); }
.expand-btn.open { transform: rotate(180deg); }

/* Expanded Detail */
.card-detail {
  display: none;
  padding: 0 18px 16px;
  border-top: 1px solid var(--border);
  margin-top: 0;
}

.card-detail.show { display: block; padding-top: 14px; }

.detail-section {
  margin-bottom: 12px;
}

.detail-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.detail-keywords {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.kw-tag {
  padding: 3px 8px;
  border-radius: 5px;
  font-size: 11px;
  background: var(--surface3);
  color: var(--text2);
}

.detail-related {
  display: flex;
  gap: 6px;
}

.rel-tag {
  padding: 3px 8px;
  border-radius: 5px;
  font-size: 12px;
  font-family: 'DM Mono';
  font-weight: 500;
  background: rgba(139,92,246,0.1);
  color: var(--purple);
}

.detail-notes {
  font-size: 12px;
  color: var(--text2);
  line-height: 1.5;
}

/* Add Form */
.add-section {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 24px;
}

.add-form {
  display: none;
  background: var(--surface);
  border: 1px dashed var(--border-active);
  border-radius: 14px;
  padding: 20px;
  margin-bottom: 16px;
}

.add-form.show { display: block; }

.form-row {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.form-input {
  flex: 1;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 9px 12px;
  color: var(--text);
  font-size: 13px;
  font-family: 'DM Sans';
  outline: none;
}

.form-input:focus { border-color: var(--blue); }
.form-input::placeholder { color: var(--text3); }

.form-input-sm { max-width: 100px; }
.form-input-ticker { max-width: 80px; font-family: 'DM Mono'; text-transform: uppercase; }

/* Floating Save Bar */
.save-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 14px 24px;
  display: none;
  align-items: center;
  justify-content: center;
  gap: 12px;
  z-index: 100;
  backdrop-filter: blur(12px);
}

.save-bar.show { display: flex; }
.save-bar .change-count { font-size: 13px; color: var(--amber); font-weight: 600; }

/* Toast */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 14px 20px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  z-index: 200;
  transform: translateX(120%);
  transition: transform 0.3s ease;
}

.toast.show { transform: translateX(0); }
.toast-success { background: var(--green); color: #fff; }
.toast-error { background: var(--red); color: #fff; }

/* Setup overlay */
.setup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 300;
  backdrop-filter: blur(4px);
}

.setup-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 32px;
  max-width: 420px;
  width: 90%;
}

.setup-box h2 { font-size: 18px; margin-bottom: 8px; }
.setup-box p { font-size: 13px; color: var(--text2); margin-bottom: 16px; line-height: 1.6; }

.setup-box .form-input { width: 100%; margin-bottom: 12px; }

@media (max-width: 640px) {
  .header { padding: 20px 16px 16px; }
  .toolbar, .list, .add-section { padding-left: 16px; padding-right: 16px; }
  .card-main { padding: 14px; }
  .form-row { flex-direction: column; }
  .form-input-sm, .form-input-ticker { max-width: 100%; }
}
</style>
</head>
<body>

<!-- Setup Overlay (Ï≤´ ÏÇ¨Ïö© Ïãú) -->
<div class="setup-overlay" id="setupOverlay" style="display:none">
  <div class="setup-box">
    <h2>üîê GitHub Ïó∞Í≤∞</h2>
    <p>ÏõåÏπòÎ¶¨Ïä§Ìä∏ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ Î†àÌè¨Ïóê Ï†ÄÏû•ÌïòÎ†§Î©¥ GitHub Personal Access TokenÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.
       <br>Î†àÌè¨ Settings ‚Üí Contents Í∂åÌïúÎßå ÏûàÏúºÎ©¥ Îê©ÎãàÎã§.</p>
    <input class="form-input" id="setupToken" type="password" placeholder="ghp_xxxx... (GitHub PAT)">
    <input class="form-input" id="setupRepo" type="text" placeholder="hong4137/stockemergent" value="hong4137/stockemergent">
    <div style="display:flex; gap:8px; margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="saveSetup()">Ïó∞Í≤∞</button>
      <button class="btn" onclick="skipSetup()">ÎÇòÏ§ëÏóê</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <div class="dot"></div>
    <h1>Sentinel Watchlist</h1>
  </div>
  <div class="header-right">
    <span class="badge badge-active" id="activeCount">0 active</span>
    <span class="badge badge-total" id="totalCount">0 total</span>
  </div>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <input class="search-box" id="searchBox" type="text" placeholder="Ï¢ÖÎ™© Í≤ÄÏÉâ...">
  <button class="btn" id="addBtn" onclick="toggleAddForm()">+ Ï∂îÍ∞Ä</button>
</div>

<!-- Add Form -->
<div class="add-section">
  <div class="add-form" id="addForm">
    <div class="form-row">
      <input class="form-input form-input-ticker" id="newTicker" placeholder="NVDA">
      <input class="form-input" id="newName" placeholder="ÌöåÏÇ¨Î™Ö (Ïòà: NVIDIA)">
      <input class="form-input" id="newSector" placeholder="ÏÑπÌÑ∞">
    </div>
    <div class="form-row">
      <input class="form-input" id="newKeywords" placeholder="ÌÇ§ÏõåÎìú (ÏâºÌëú Íµ¨Î∂Ñ: GPU, AI chip, Blackwell)">
    </div>
    <div class="form-row">
      <input class="form-input" id="newRelated" placeholder="Í¥ÄÎ†® Ï¢ÖÎ™© (ÏâºÌëú Íµ¨Î∂Ñ: AMD, TSM)">
      <select class="form-input form-input-sm" id="newChina">
        <option value="low">China: Low</option>
        <option value="medium">China: Medium</option>
        <option value="high">China: High</option>
      </select>
    </div>
    <div class="form-row">
      <input class="form-input" id="newNotes" placeholder="Î©îÎ™® (ÏÑ†ÌÉù)">
      <button class="btn btn-primary" onclick="addStock()">Ï∂îÍ∞Ä</button>
    </div>
  </div>
</div>

<!-- Stock List -->
<div class="list" id="stockList"></div>

<!-- Floating Save Bar -->
<div class="save-bar" id="saveBar">
  <span class="change-count" id="changeCount"></span>
  <button class="btn btn-save" id="saveBtn" onclick="saveToGitHub()">üíæ GitHubÏóê Ï†ÄÏû•</button>
  <button class="btn" onclick="discardChanges()">Ï∑®ÏÜå</button>
</div>

<script>
// ============================================================
// State
// ============================================================
let watchlist = [];
let originalJson = "";
let hasChanges = false;

const STORAGE_KEY = "sentinel_gh";
const DEFAULT_WATCHLIST = [
  {
    active: true, ticker: "AMAT", name: "Applied Materials",
    sector: "Semiconductor Equipment",
    related: ["ASML","LRCX","KLAC","TSM","INTC"],
    keywords: ["Applied Materials","AMAT","EUV","High-NA","GAA","advanced packaging","HBM","CMP","CVD","etch","ion implant","WFE","BIS","export control","CHIPS Act"],
    china_exposure: "high", notes: "WFE 1ÏúÑ. AI/HBM ÏàòÌòú. BIS ÏàòÏ∂úÍ∑úÏ†ú Î¶¨Ïä§ÌÅ¨."
  },
  {
    active: true, ticker: "NVDA", name: "NVIDIA",
    sector: "Semiconductor",
    related: ["AMD","AVGO","TSM","SMCI","MRVL"],
    keywords: ["NVIDIA","NVDA","GPU","Blackwell","Rubin","data center","AI chip","CUDA","HBM","Jensen Huang","hyperscaler","inference"],
    china_exposure: "high", notes: "AI GPU ÏßÄÎ∞∞Ï†Å. Îç∞Ïù¥ÌÑ∞ÏÑºÌÑ∞ Îß§Ï∂ú ÌïµÏã¨."
  },
  {
    active: true, ticker: "ASML", name: "ASML Holding",
    sector: "Semiconductor Equipment",
    related: ["AMAT","LRCX","KLAC","TSM"],
    keywords: ["ASML","EUV","High-NA","lithography","DUV","TSMC","Samsung foundry","Intel foundry"],
    china_exposure: "high", notes: "EUV ÎèÖÏ†ê. ÏàòÏ∂úÍ∑úÏ†ú ÏßÅÏ†ë ÏòÅÌñ•."
  },
  {
    active: true, ticker: "TSM", name: "TSMC",
    sector: "Semiconductor Foundry",
    related: ["AMAT","ASML","NVDA","AAPL"],
    keywords: ["TSMC","TSM","foundry","N2","N3","A16","advanced packaging","CoWoS","capex","Arizona fab","Japan fab"],
    china_exposure: "medium", notes: "ÌååÏö¥ÎìúÎ¶¨ 1ÏúÑ. CapExÍ∞Ä Ïû•ÎπÑÏ£º ÏÑ†ÌñâÏßÄÌëú."
  },
  {
    active: false, ticker: "AMD", name: "Advanced Micro Devices",
    sector: "Semiconductor",
    related: ["NVDA","INTC","TSM"],
    keywords: ["AMD","EPYC","Ryzen","MI300","MI400","data center","AI accelerator","Lisa Su"],
    china_exposure: "medium", notes: "NVDA ÎåÄÏïà. AI Í∞ÄÏÜçÍ∏∞ ÏãúÏû• ÏßÑÏûÖ."
  },
  {
    active: false, ticker: "AVGO", name: "Broadcom",
    sector: "Semiconductor",
    related: ["NVDA","MRVL","QCOM"],
    keywords: ["Broadcom","AVGO","custom silicon","ASIC","VMware","networking","AI networking","Hock Tan"],
    china_exposure: "low", notes: "Ïª§Ïä§ÌÖÄ AIÏπ© + VMware. ÎÑ§Ìä∏ÏõåÌÇπ Í∞ïÏûê."
  },
  {
    active: false, ticker: "SMCI", name: "Super Micro Computer",
    sector: "IT Infrastructure",
    related: ["NVDA","DELL","HPE"],
    keywords: ["Super Micro","SMCI","AI server","GPU server","liquid cooling","rack scale"],
    china_exposure: "low", notes: "AI ÏÑúÎ≤Ñ Ï°∞Î¶Ω. NVDA GPU ÌÉëÏû¨ ÏÑúÎ≤Ñ ÎåÄÌëúÏ£º."
  }
];

// ============================================================
// Init
// ============================================================
window.addEventListener("DOMContentLoaded", async () => {
  const gh = getGHConfig();
  
  if (gh.token && gh.repo) {
    await loadFromGitHub();
  } else {
    // GitHub ÎØ∏Ïó∞Í≤∞ Ïãú Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
    watchlist = JSON.parse(JSON.stringify(DEFAULT_WATCHLIST));
    originalJson = JSON.stringify(watchlist);
    render();
    // Ï≤òÏùåÏù¥Î©¥ ÏÑ§Ï†ï Ïò§Î≤ÑÎ†àÏù¥
    if (!gh.token) {
      document.getElementById("setupOverlay").style.display = "flex";
    }
  }
  
  document.getElementById("searchBox").addEventListener("input", render);
});

// ============================================================
// GitHub Config
// ============================================================
function getGHConfig() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  } catch { return {}; }
}

function saveSetup() {
  const token = document.getElementById("setupToken").value.trim();
  const repo = document.getElementById("setupRepo").value.trim();
  if (!token || !repo) return;
  
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ token, repo }));
  document.getElementById("setupOverlay").style.display = "none";
  toast("‚úÖ GitHub Ïó∞Í≤∞ ÏôÑÎ£å", "success");
  loadFromGitHub();
}

function skipSetup() {
  document.getElementById("setupOverlay").style.display = "none";
  watchlist = JSON.parse(JSON.stringify(DEFAULT_WATCHLIST));
  originalJson = JSON.stringify(watchlist);
  render();
}

// ============================================================
// GitHub API
// ============================================================
async function loadFromGitHub() {
  const { token, repo } = getGHConfig();
  if (!token || !repo) return;
  
  try {
    const resp = await fetch(`https://api.github.com/repos/${repo}/contents/watchlist.json`, {
      headers: { Authorization: `Bearer ${token}`, Accept: "application/vnd.github.v3+json" }
    });
    
    if (resp.ok) {
      const data = await resp.json();
      const content = JSON.parse(atob(data.content));
      watchlist = content.watchlist || [];
      originalJson = JSON.stringify(watchlist);
      render();
    } else if (resp.status === 404) {
      // ÌååÏùº ÏóÜÏùå ‚Üí Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
      watchlist = JSON.parse(JSON.stringify(DEFAULT_WATCHLIST));
      originalJson = JSON.stringify(watchlist);
      hasChanges = true;
      render();
      updateSaveBar();
      toast("üìã watchlist.json ÎØ∏Î∞úÍ≤¨ ‚Äî Í∏∞Î≥∏ Î™©Î°ù Î°úÎìúÎê®. Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.", "success");
    } else {
      throw new Error(`HTTP ${resp.status}`);
    }
  } catch (e) {
    console.error(e);
    toast("‚ö†Ô∏è GitHub Î°úÎìú Ïã§Ìå®: " + e.message, "error");
    watchlist = JSON.parse(JSON.stringify(DEFAULT_WATCHLIST));
    originalJson = JSON.stringify(watchlist);
    render();
  }
}

async function saveToGitHub() {
  const { token, repo } = getGHConfig();
  
  if (!token || !repo) {
    document.getElementById("setupOverlay").style.display = "flex";
    return;
  }
  
  const btn = document.getElementById("saveBtn");
  btn.disabled = true;
  btn.textContent = "Ï†ÄÏû• Ï§ë...";
  
  try {
    // ÌòÑÏû¨ ÌååÏùº SHA Í∞ÄÏ†∏Ïò§Í∏∞
    let sha = null;
    try {
      const existing = await fetch(`https://api.github.com/repos/${repo}/contents/watchlist.json`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (existing.ok) {
        const d = await existing.json();
        sha = d.sha;
      }
    } catch {}
    
    const fileContent = JSON.stringify({ watchlist }, null, 2);
    const body = {
      message: `üìã watchlist ÏóÖÎç∞Ïù¥Ìä∏: ${watchlist.filter(w=>w.active).length}Í∞ú ÌôúÏÑ±`,
      content: btoa(unescape(encodeURIComponent(fileContent))),
    };
    if (sha) body.sha = sha;
    
    const resp = await fetch(`https://api.github.com/repos/${repo}/contents/watchlist.json`, {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    });
    
    if (resp.ok) {
      originalJson = JSON.stringify(watchlist);
      hasChanges = false;
      updateSaveBar();
      toast("‚úÖ GitHubÏóê Ï†ÄÏû• ÏôÑÎ£å!", "success");
    } else {
      const err = await resp.json();
      throw new Error(err.message || `HTTP ${resp.status}`);
    }
  } catch (e) {
    toast("‚ö†Ô∏è Ï†ÄÏû• Ïã§Ìå®: " + e.message, "error");
  } finally {
    btn.disabled = false;
    btn.textContent = "üíæ GitHubÏóê Ï†ÄÏû•";
  }
}

// ============================================================
// Render
// ============================================================
function render() {
  const query = document.getElementById("searchBox").value.toLowerCase();
  const container = document.getElementById("stockList");
  
  const filtered = watchlist.filter(w => {
    if (!query) return true;
    return w.ticker.toLowerCase().includes(query) ||
           w.name.toLowerCase().includes(query) ||
           w.sector.toLowerCase().includes(query);
  });
  
  container.innerHTML = filtered.map((w, idx) => {
    const realIdx = watchlist.indexOf(w);
    const chinaClass = w.china_exposure === "high" ? "tag-china-high" :
                       w.china_exposure === "medium" ? "tag-china-medium" : "";
    
    return `
      <div class="card ${w.active ? '' : 'inactive'}" id="card-${realIdx}">
        <div class="card-main">
          <div class="toggle" onclick="event.stopPropagation()">
            <input type="checkbox" ${w.active ? 'checked' : ''} 
                   onchange="toggleActive(${realIdx}, this.checked)">
            <div class="toggle-track"></div>
            <div class="toggle-thumb"></div>
          </div>
          <div class="card-info" onclick="toggleDetail(${realIdx})">
            <div class="card-top">
              <span class="ticker">${w.ticker}</span>
              <span class="name">${w.name}</span>
            </div>
            <div class="card-bottom">
              <span class="tag tag-sector">${w.sector}</span>
              ${w.china_exposure !== 'low' ? `<span class="tag ${chinaClass}">üá®üá≥ ${w.china_exposure}</span>` : ''}
              <span class="tag">${w.keywords.length} keywords</span>
              <span class="tag">${w.related.length} related</span>
            </div>
          </div>
          <button class="expand-btn" id="expand-${realIdx}" onclick="toggleDetail(${realIdx})">‚ñæ</button>
        </div>
        <div class="card-detail" id="detail-${realIdx}">
          <div class="detail-section">
            <div class="detail-label">Keywords</div>
            <div class="detail-keywords">
              ${w.keywords.map(k => `<span class="kw-tag">${k}</span>`).join('')}
            </div>
          </div>
          <div class="detail-section">
            <div class="detail-label">Related</div>
            <div class="detail-related">
              ${w.related.map(r => `<span class="rel-tag">${r}</span>`).join('')}
            </div>
          </div>
          ${w.notes ? `
          <div class="detail-section">
            <div class="detail-label">Notes</div>
            <div class="detail-notes">${w.notes}</div>
          </div>` : ''}
          <div style="margin-top:12px; display:flex; gap:6px;">
            <button class="btn" style="font-size:12px; padding:6px 12px;" 
                    onclick="deleteStock(${realIdx})">üóë ÏÇ≠Ï†ú</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Counts
  const activeN = watchlist.filter(w => w.active).length;
  document.getElementById("activeCount").textContent = `${activeN} active`;
  document.getElementById("totalCount").textContent = `${watchlist.length} total`;
}

// ============================================================
// Actions
// ============================================================
function toggleActive(idx, checked) {
  watchlist[idx].active = checked;
  markChanged();
  render();
}

function toggleDetail(idx) {
  const el = document.getElementById(`detail-${idx}`);
  const btn = document.getElementById(`expand-${idx}`);
  el.classList.toggle("show");
  btn.classList.toggle("open");
}

function toggleAddForm() {
  document.getElementById("addForm").classList.toggle("show");
  if (document.getElementById("addForm").classList.contains("show")) {
    document.getElementById("newTicker").focus();
  }
}

function addStock() {
  const ticker = document.getElementById("newTicker").value.trim().toUpperCase();
  const name = document.getElementById("newName").value.trim();
  if (!ticker || !name) { toast("Ìã∞Ïª§ÏôÄ ÌöåÏÇ¨Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî", "error"); return; }
  
  if (watchlist.some(w => w.ticker === ticker)) {
    toast(`${ticker}ÏùÄ Ïù¥ÎØ∏ Î™©Î°ùÏóê ÏûàÏäµÎãàÎã§`, "error"); return;
  }
  
  const kw = document.getElementById("newKeywords").value.trim();
  const rel = document.getElementById("newRelated").value.trim();
  
  watchlist.push({
    active: true,
    ticker,
    name,
    sector: document.getElementById("newSector").value.trim() || "Other",
    related: rel ? rel.split(",").map(s => s.trim().toUpperCase()) : [],
    keywords: kw ? [ticker, name, ...kw.split(",").map(s => s.trim())] : [ticker, name],
    china_exposure: document.getElementById("newChina").value,
    notes: document.getElementById("newNotes").value.trim(),
  });
  
  // Reset form
  ["newTicker","newName","newSector","newKeywords","newRelated","newNotes"].forEach(
    id => document.getElementById(id).value = ""
  );
  document.getElementById("addForm").classList.remove("show");
  
  markChanged();
  render();
  toast(`‚úÖ ${ticker} Ï∂îÍ∞ÄÎê®`, "success");
}

function deleteStock(idx) {
  const ticker = watchlist[idx].ticker;
  if (!confirm(`${ticker}ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
  watchlist.splice(idx, 1);
  markChanged();
  render();
  toast(`üóë ${ticker} ÏÇ≠Ï†úÎê®`, "success");
}

function discardChanges() {
  watchlist = JSON.parse(originalJson);
  hasChanges = false;
  updateSaveBar();
  render();
}

// ============================================================
// Change Tracking
// ============================================================
function markChanged() {
  hasChanges = JSON.stringify(watchlist) !== originalJson;
  updateSaveBar();
}

function updateSaveBar() {
  const bar = document.getElementById("saveBar");
  if (hasChanges) {
    bar.classList.add("show");
    const changes = countChanges();
    document.getElementById("changeCount").textContent = `${changes}Í∞ú Î≥ÄÍ≤ΩÏÇ¨Ìï≠`;
  } else {
    bar.classList.remove("show");
  }
}

function countChanges() {
  const orig = JSON.parse(originalJson);
  let count = 0;
  // Í∏∏Ïù¥ Ï∞®Ïù¥
  count += Math.abs(watchlist.length - orig.length);
  // ÎÇ¥Ïö© Ï∞®Ïù¥
  const minLen = Math.min(watchlist.length, orig.length);
  for (let i = 0; i < minLen; i++) {
    if (JSON.stringify(watchlist[i]) !== JSON.stringify(orig[i])) count++;
  }
  return Math.max(1, count);
}

// ============================================================
// Toast
// ============================================================
function toast(msg, type = "success") {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.className = `toast toast-${type} show`;
  setTimeout(() => el.classList.remove("show"), 3000);
}
</script>
</body>
</html>
